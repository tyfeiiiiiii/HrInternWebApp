@model List<HrInternWebApp.Entity.SurveyPredictionResults>

<div class="container-fluid" style="background-color: #0E3B31; height: 100vh;">
    <div class="row h-100">
        <div class="col-md-3 p-3" style="background-color: #1A3E37;">
            @await Html.PartialAsync("Sidebar")
        </div>

        <div class="col-md-9" style="background-color: white; padding: 20px;">
            <nav class="navbar navbar-light bg-light justify-content-between">
                <a class="navbar-brand">Prediction Result</a>

                <form class="form-inline d-flex" id="searchForm" method="get" action="">
                    <input class="form-control mr-2" type="search" id="empIdSearch" name="empId" placeholder="Search by Employee ID" aria-label="Search">
                </form>
            </nav>

            <table class="table table-bordered table-striped">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Employee ID</th>
                        <th>Username</th>
                        <th>Model 1</th>
                        <th>Model 2</th>
                        <th>Created At</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="predictionResults">
                    @if (Model != null && Model.Any())
                    {
                        int count = 1;
                        foreach (var result in Model)
                        {
                            <tr>
                                <td>@count</td>
                                <td>@result.Employee.empId</td>
                                <td>@result.Employee.username</td>
                                <td>@result.PredictionModel1</td>
                                <td>@result.PredictionModel2</td>
                                <td>@result.CreatedAt.ToString("yyyy-MM-dd HH:mm:ss")</td>
                                <td>
                                    <a asp-action="PredictionByEmployee" asp-route-empId="@result.Employee.empId" asp-route-username="@result.Employee.username" class="btn btn-primary btn-sm">View All</a>
                                </td>
                            </tr>
                            count++;
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="7" class="text-center">No prediction results available.</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script>
                $(document).ready(function () {

            // Function to fetch predictions from the server
            function fetchPredictions(empId = '') {
                $.ajax({
                    url: '@Url.Action("SearchPredictionByEmpId", "Survey")',
                    type: 'GET',
                    data: { empId: empId }, // Send the empId if available
                    success: function (data) {
                        $('#predictionResults').empty();

                        if (Array.isArray(data) && data.length > 0) {
                            $.each(data, function (index, result) {
                                var viewUrl = `/Survey/PredictionByEmployee?empId=${encodeURIComponent(result.employee.empId)}&username=${encodeURIComponent(result.employee.username)}`;

                                $('#predictionResults').append(`
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td>${result.employee.empId}</td>
                                        <td>${result.employee.username}</td>
                                        <td>${result.predictionModel1}</td>
                                        <td>${result.predictionModel2}</td>
                                        <td>${new Date(result.createdAt).toLocaleString()}</td>
                                        <td>
                                            <a href="${viewUrl}" class="btn btn-primary btn-sm">View All</a>
                                        </td>
                                    </tr>
                                `);
                            });
                        } else {
                            $('#predictionResults').append('<tr><td colspan="7" class="text-center">No results found for this Employee ID.</td></tr>');
                        }
                    },
                    error: function () {
                        alert('Error retrieving prediction results. Please try again.');
                    }
                });
            }

            // Load all predictions on page load
            fetchPredictions();

            // Search predictions when the input changes
            $('#empIdSearch').on('input', function () {
                var empId = $(this).val();
                fetchPredictions(empId);  // Fetch predictions based on search input
            });
        });

    </script>
}
